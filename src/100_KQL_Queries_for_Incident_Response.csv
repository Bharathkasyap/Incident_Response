Category,Query Title,KQL Query
Account Compromise,Failed Logon Attempts,"DeviceLogonEvents | where ActionType == ""LogonFailed"" | summarize count() by AccountName"
Account Compromise,Multiple Logins from Different Locations,"SigninLogs | summarize by Account, Location, bin(TimeGenerated, 1h)"
Account Compromise,Password Spray Detection,"DeviceLogonEvents | where AccountName in (""admin"", ""administrator"") | summarize count() by RemoteIP"
Lateral Movement,RDP Access,DeviceNetworkEvents | where RemotePort == 3389
Lateral Movement,Admin Share Access,DeviceNetworkEvents | where RemotePort == 445
Lateral Movement,Unusual SMB Traffic,"DeviceNetworkEvents | where RemotePort == 445 and InitiatingProcessFileName != ""System"""
Persistence,Registry Run Keys,"DeviceRegistryEvents | where RegistryKey has ""Run"" and ActionType == ""RegistryValueSet"""
Persistence,Scheduled Tasks Created,"DeviceProcessEvents | where ProcessCommandLine has ""schtasks"""
Persistence,WMI Persistence,"DeviceProcessEvents | where ProcessCommandLine has ""wmic"""
Privilege Escalation,New Local Admins,"DeviceEvents | where ActionType == ""UserAddedToAdminGroup"""
Privilege Escalation,Token Impersonation,"DeviceProcessEvents | where ProcessCommandLine has ""Invoke-TokenManipulation"""
Privilege Escalation,Use of PsExec,"DeviceProcessEvents | where FileName == ""PsExec.exe"""
Defense Evasion,AV Disabled,"DeviceEvents | where ActionType has ""AntivirusDisabled"""
Defense Evasion,Script Obfuscation,"DeviceProcessEvents | where ProcessCommandLine has_any(""FromBase64String"", ""Invoke-Expression"")"
Defense Evasion,Use of regsvr32,"DeviceProcessEvents | where FileName == ""regsvr32.exe"""
Execution,Suspicious PowerShell Commands,"DeviceProcessEvents | where FileName == ""powershell.exe"" and ProcessCommandLine has_any(""-enc"", ""Invoke-WebRequest"")"
Execution,Malicious Office Macros,"DeviceProcessEvents | where InitiatingProcessFileName endswith "".docm"""
Execution,Encoded Command Line,"DeviceProcessEvents | where ProcessCommandLine has ""-enc"""
Command and Control (C2),DNS Tunneling,"DeviceNetworkEvents | where RemoteUrl contains "".xyz"""
Command and Control (C2),Unusual Beaconing,"DeviceNetworkEvents | summarize count() by RemoteIP, bin(Timestamp, 1h)"
Command and Control (C2),Long Domain Chains,"DeviceEvents | where RemoteUrl contains "".co."" and strlen(RemoteUrl) > 100"
Data Exfiltration,Large Data Transfer,"DeviceNetworkEvents | where Protocol == ""HTTPS"" | summarize sum(SentBytes) by RemoteIP"
Data Exfiltration,Cloud Upload Detected,"DeviceNetworkEvents | where RemoteUrl has_any(""drive.google.com"", ""dropbox.com"")"
Data Exfiltration,File Copy to USB,"DeviceEvents | where ActionType == ""UsbFileCopy"""
Account Compromise,Failed Logon Attempts,"DeviceLogonEvents | where ActionType == ""LogonFailed"" | summarize count() by AccountName"
Account Compromise,Multiple Logins from Different Locations,"SigninLogs | summarize by Account, Location, bin(TimeGenerated, 1h)"
Account Compromise,Password Spray Detection,"DeviceLogonEvents | where AccountName in (""admin"", ""administrator"") | summarize count() by RemoteIP"
Lateral Movement,RDP Access,DeviceNetworkEvents | where RemotePort == 3389
Lateral Movement,Admin Share Access,DeviceNetworkEvents | where RemotePort == 445
Lateral Movement,Unusual SMB Traffic,"DeviceNetworkEvents | where RemotePort == 445 and InitiatingProcessFileName != ""System"""
Persistence,Registry Run Keys,"DeviceRegistryEvents | where RegistryKey has ""Run"" and ActionType == ""RegistryValueSet"""
Persistence,Scheduled Tasks Created,"DeviceProcessEvents | where ProcessCommandLine has ""schtasks"""
Persistence,WMI Persistence,"DeviceProcessEvents | where ProcessCommandLine has ""wmic"""
Privilege Escalation,New Local Admins,"DeviceEvents | where ActionType == ""UserAddedToAdminGroup"""
Privilege Escalation,Token Impersonation,"DeviceProcessEvents | where ProcessCommandLine has ""Invoke-TokenManipulation"""
Privilege Escalation,Use of PsExec,"DeviceProcessEvents | where FileName == ""PsExec.exe"""
Defense Evasion,AV Disabled,"DeviceEvents | where ActionType has ""AntivirusDisabled"""
Defense Evasion,Script Obfuscation,"DeviceProcessEvents | where ProcessCommandLine has_any(""FromBase64String"", ""Invoke-Expression"")"
Defense Evasion,Use of regsvr32,"DeviceProcessEvents | where FileName == ""regsvr32.exe"""
Execution,Suspicious PowerShell Commands,"DeviceProcessEvents | where FileName == ""powershell.exe"" and ProcessCommandLine has_any(""-enc"", ""Invoke-WebRequest"")"
Execution,Malicious Office Macros,"DeviceProcessEvents | where InitiatingProcessFileName endswith "".docm"""
Execution,Encoded Command Line,"DeviceProcessEvents | where ProcessCommandLine has ""-enc"""
Command and Control (C2),DNS Tunneling,"DeviceNetworkEvents | where RemoteUrl contains "".xyz"""
Command and Control (C2),Unusual Beaconing,"DeviceNetworkEvents | summarize count() by RemoteIP, bin(Timestamp, 1h)"
Command and Control (C2),Long Domain Chains,"DeviceEvents | where RemoteUrl contains "".co."" and strlen(RemoteUrl) > 100"
Data Exfiltration,Large Data Transfer,"DeviceNetworkEvents | where Protocol == ""HTTPS"" | summarize sum(SentBytes) by RemoteIP"
Data Exfiltration,Cloud Upload Detected,"DeviceNetworkEvents | where RemoteUrl has_any(""drive.google.com"", ""dropbox.com"")"
Data Exfiltration,File Copy to USB,"DeviceEvents | where ActionType == ""UsbFileCopy"""
Account Compromise,Failed Logon Attempts,"DeviceLogonEvents | where ActionType == ""LogonFailed"" | summarize count() by AccountName"
Account Compromise,Multiple Logins from Different Locations,"SigninLogs | summarize by Account, Location, bin(TimeGenerated, 1h)"
Account Compromise,Password Spray Detection,"DeviceLogonEvents | where AccountName in (""admin"", ""administrator"") | summarize count() by RemoteIP"
Lateral Movement,RDP Access,DeviceNetworkEvents | where RemotePort == 3389
Lateral Movement,Admin Share Access,DeviceNetworkEvents | where RemotePort == 445
Lateral Movement,Unusual SMB Traffic,"DeviceNetworkEvents | where RemotePort == 445 and InitiatingProcessFileName != ""System"""
Persistence,Registry Run Keys,"DeviceRegistryEvents | where RegistryKey has ""Run"" and ActionType == ""RegistryValueSet"""
Persistence,Scheduled Tasks Created,"DeviceProcessEvents | where ProcessCommandLine has ""schtasks"""
Persistence,WMI Persistence,"DeviceProcessEvents | where ProcessCommandLine has ""wmic"""
Privilege Escalation,New Local Admins,"DeviceEvents | where ActionType == ""UserAddedToAdminGroup"""
Privilege Escalation,Token Impersonation,"DeviceProcessEvents | where ProcessCommandLine has ""Invoke-TokenManipulation"""
Privilege Escalation,Use of PsExec,"DeviceProcessEvents | where FileName == ""PsExec.exe"""
Defense Evasion,AV Disabled,"DeviceEvents | where ActionType has ""AntivirusDisabled"""
Defense Evasion,Script Obfuscation,"DeviceProcessEvents | where ProcessCommandLine has_any(""FromBase64String"", ""Invoke-Expression"")"
Defense Evasion,Use of regsvr32,"DeviceProcessEvents | where FileName == ""regsvr32.exe"""
Execution,Suspicious PowerShell Commands,"DeviceProcessEvents | where FileName == ""powershell.exe"" and ProcessCommandLine has_any(""-enc"", ""Invoke-WebRequest"")"
Execution,Malicious Office Macros,"DeviceProcessEvents | where InitiatingProcessFileName endswith "".docm"""
Execution,Encoded Command Line,"DeviceProcessEvents | where ProcessCommandLine has ""-enc"""
Command and Control (C2),DNS Tunneling,"DeviceNetworkEvents | where RemoteUrl contains "".xyz"""
Command and Control (C2),Unusual Beaconing,"DeviceNetworkEvents | summarize count() by RemoteIP, bin(Timestamp, 1h)"
Command and Control (C2),Long Domain Chains,"DeviceEvents | where RemoteUrl contains "".co."" and strlen(RemoteUrl) > 100"
Data Exfiltration,Large Data Transfer,"DeviceNetworkEvents | where Protocol == ""HTTPS"" | summarize sum(SentBytes) by RemoteIP"
Data Exfiltration,Cloud Upload Detected,"DeviceNetworkEvents | where RemoteUrl has_any(""drive.google.com"", ""dropbox.com"")"
Data Exfiltration,File Copy to USB,"DeviceEvents | where ActionType == ""UsbFileCopy"""
Account Compromise,Failed Logon Attempts,"DeviceLogonEvents | where ActionType == ""LogonFailed"" | summarize count() by AccountName"
Account Compromise,Multiple Logins from Different Locations,"SigninLogs | summarize by Account, Location, bin(TimeGenerated, 1h)"
Account Compromise,Password Spray Detection,"DeviceLogonEvents | where AccountName in (""admin"", ""administrator"") | summarize count() by RemoteIP"
Lateral Movement,RDP Access,DeviceNetworkEvents | where RemotePort == 3389
Lateral Movement,Admin Share Access,DeviceNetworkEvents | where RemotePort == 445
Lateral Movement,Unusual SMB Traffic,"DeviceNetworkEvents | where RemotePort == 445 and InitiatingProcessFileName != ""System"""
Persistence,Registry Run Keys,"DeviceRegistryEvents | where RegistryKey has ""Run"" and ActionType == ""RegistryValueSet"""
Persistence,Scheduled Tasks Created,"DeviceProcessEvents | where ProcessCommandLine has ""schtasks"""
Persistence,WMI Persistence,"DeviceProcessEvents | where ProcessCommandLine has ""wmic"""
Privilege Escalation,New Local Admins,"DeviceEvents | where ActionType == ""UserAddedToAdminGroup"""
Privilege Escalation,Token Impersonation,"DeviceProcessEvents | where ProcessCommandLine has ""Invoke-TokenManipulation"""
Privilege Escalation,Use of PsExec,"DeviceProcessEvents | where FileName == ""PsExec.exe"""
Defense Evasion,AV Disabled,"DeviceEvents | where ActionType has ""AntivirusDisabled"""
Defense Evasion,Script Obfuscation,"DeviceProcessEvents | where ProcessCommandLine has_any(""FromBase64String"", ""Invoke-Expression"")"
Defense Evasion,Use of regsvr32,"DeviceProcessEvents | where FileName == ""regsvr32.exe"""
Execution,Suspicious PowerShell Commands,"DeviceProcessEvents | where FileName == ""powershell.exe"" and ProcessCommandLine has_any(""-enc"", ""Invoke-WebRequest"")"
Execution,Malicious Office Macros,"DeviceProcessEvents | where InitiatingProcessFileName endswith "".docm"""
Execution,Encoded Command Line,"DeviceProcessEvents | where ProcessCommandLine has ""-enc"""
Command and Control (C2),DNS Tunneling,"DeviceNetworkEvents | where RemoteUrl contains "".xyz"""
Command and Control (C2),Unusual Beaconing,"DeviceNetworkEvents | summarize count() by RemoteIP, bin(Timestamp, 1h)"
Command and Control (C2),Long Domain Chains,"DeviceEvents | where RemoteUrl contains "".co."" and strlen(RemoteUrl) > 100"
Data Exfiltration,Large Data Transfer,"DeviceNetworkEvents | where Protocol == ""HTTPS"" | summarize sum(SentBytes) by RemoteIP"
Data Exfiltration,Cloud Upload Detected,"DeviceNetworkEvents | where RemoteUrl has_any(""drive.google.com"", ""dropbox.com"")"
Data Exfiltration,File Copy to USB,"DeviceEvents | where ActionType == ""UsbFileCopy"""
Account Compromise,Failed Logon Attempts,"DeviceLogonEvents | where ActionType == ""LogonFailed"" | summarize count() by AccountName"
Account Compromise,Multiple Logins from Different Locations,"SigninLogs | summarize by Account, Location, bin(TimeGenerated, 1h)"
Account Compromise,Password Spray Detection,"DeviceLogonEvents | where AccountName in (""admin"", ""administrator"") | summarize count() by RemoteIP"
Lateral Movement,RDP Access,DeviceNetworkEvents | where RemotePort == 3389
